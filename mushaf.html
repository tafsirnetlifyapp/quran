<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Mushaf Dinamis V1/V2 + Terjemah</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      background: #fefcf8;
      padding: 1em;
      font-family: sans-serif;
      direction: rtl;
      margin: 0;
    }
    h2 {
      text-align: center;
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      margin-bottom: 1rem;
    }
    .controls {
      direction: ltr;
      max-width: 800px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.8em;
      justify-content: center;
      align-items: center;
      padding: 0.5em;
    }
    .controls label {
      font-size: clamp(0.85rem, 2.5vw, 1rem);
      display: flex;
      flex-direction: column;
    }
    select, button, input[type="file"], input[type="text"] {
      font-size: clamp(1rem, 3vw, 1.2rem);
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #4cafef;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background-color: #007acc;
    }
    .version-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.8em;
      margin-top: 1em;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .version-buttons button {
      padding: 0.8em;
      border-radius: 8px;
      background-color: #4cafef;
      color: #fff;
      border: none;
      font-size: clamp(1rem, 2.5vw, 1.1rem);
      cursor: pointer;
    }
    .version-buttons button:hover {
      background-color: #007acc;
    }
    .quran-v1, .quran-v2 {
      font-size: clamp(1.8em, 5vw, 2.5em);
      line-height: 2;
      word-spacing: 0.15em;
      text-align: center;
      user-select: text;
      margin: 2em auto;
      opacity: 0;
      transition: opacity 0.3s ease;
      display: none;
      max-width: 95%;
      overflow-wrap: break-word;
      background-size: cover;
      background-position: center;
      position: relative;
      width: 100%;
      max-width: 1080px;
      aspect-ratio: 1/1;
    }
    .quran-v2 {
      line-height: 2.2;
      word-spacing: 0.2em;
    }
    .word {
      display: inline-block;
      margin: 0;
      cursor: move;
    }
    .translation {
      font-family: sans-serif;
      font-size: clamp(1rem, 3vw, 1.2rem);
      color: #333;
      direction: ltr;
      text-align: center;
      line-height: 1.8;
      word-spacing: 0.2em;
      margin-top: 1.5em;
      padding: 0 0.5em;
      cursor: move;
    }
    .source-text {
      font-size: 1rem;
      color: #333;
      opacity: 0.8;
      position: absolute;
      bottom: 40px;
      left: 20px;
      cursor: move;
    }
    .watermark {
      font-size: 1rem;
      color: #000;
      opacity: 0.3;
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none;
    }
    @media (max-width: 600px) {
      .controls, .version-buttons {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <h2>📖 Al-Qur'an Dinamis (V1/V2 + Terjemah)</h2>
  <div class="controls">
    <label>Surah
      <select id="surahSelect"></select>
    </label>
    <label>Ayat
      <select id="ayahSelect"></select>
    </label>
    <label>Dari Kata
      <select id="wordStart"></select>
    </label>
    <label>Sampai Kata
      <select id="wordEnd"></select>
    </label>
    <label>Terjemahan
      <select id="wordTranslationId">
        <option value="33" selected>Indonesian – Islamic Affairs Ministry</option>
        <option value="20">English – Saheeh International</option>
      </select>
    </label>
    <label>Background Default
      <select id="bgSelect">
        <option value="bg1">bg1</option>
        <option value="bg2">bg2</option>
        <option value="bg3">bg3</option>
        <option value="bg4">bg4</option>
      </select>
    </label>
    <label>Upload Gambar
      <input type="file" id="bgUpload" accept="image/*">
    </label>
    <label>Link Gambar
      <input type="text" id="bgLink" placeholder="https://...">
    </label>
    <label>Contrast
      <input type="range" id="contrastControl" min="50" max="200" value="100">
    </label>
    <label>Ganti Warna
      <input type="color" id="colorPicker">
    </label>
    <label>Ganti Font Terjemah
      <select id="fontSelect">
        <option value="">Default</option>
        <option value="https://fonts.gstatic.com/s/roboto/v30/KFOmCnqEu92Fr1Mu4mxK.woff2">Roboto</option>
        <option value="https://fonts.gstatic.com/s/tajawal/v8/Iurf6YBj_oCad4k1l_TE1w.woff2">Tajawal</option>
        <option value="https://fonts.gstatic.com/s/amiri/v20/J7aRnpd8CGxBHqUp.woff2">Amiri</option>
      </select>
    </label>
    <label>&nbsp;
      <button id="customLinkButton">🔗 Tombol Link</button>
    </label>
    <label>&nbsp;
      <button id="saveImageButton">💾 Simpan Gambar</button>
    </label>
  </div>
  <div class="version-buttons">
    <button onclick="setVersion('v2')">📜 Gunakan Quran V2</button>
    <button onclick="setVersion('v1')">📄 Gunakan Quran V1</button>
  </div>
  <div id="pages"></div>
  <div id="loaderOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.8);display:flex;justify-content:center;align-items:center;z-index:9999;display:none;">
    <div style="border:8px solid #f3f3f3;border-top:8px solid #4cafef;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;"></div>
  </div>
  <style>@keyframes spin {0% { transform: rotate(0deg); }100% { transform: rotate(360deg); }}</style>
  <script>
// --- VARIABEL DASAR ---
const surahSelect = document.getElementById("surahSelect");
const ayahSelect = document.getElementById("ayahSelect");
const wordStart = document.getElementById("wordStart");
const wordEnd = document.getElementById("wordEnd");
const wordTranslationId = document.getElementById("wordTranslationId");
const fontSelect = document.getElementById("fontSelect");
const colorPicker = document.getElementById("colorPicker");
const contrastControl = document.getElementById("contrastControl");
const bgUpload = document.getElementById("bgUpload");
const bgLink = document.getElementById("bgLink");
const bgSelect = document.getElementById("bgSelect");
const pages = document.getElementById("pages");
let currentVersion = 'v1';
let words = [];

// --- SURAH LIST (SINGKAT) ---
const surahList = {
  1: ["Al-Fātiḥah"], 2: ["Al-Baqarah"], 3: ["Āl ʿImrān"], 4: ["An-Nisāʾ"],
  5: ["Al-Māʾidah"], 6: ["Al-Anʿām"], 7: ["Al-Aʿrāf"], 8: ["Al-Anfāl"],
  9: ["At-Tawbah"], 10: ["Yūnus"] // ... lanjut sesuai kebutuhan
};

Object.entries(surahList).forEach(([i, [name]]) => {
  surahSelect.appendChild(new Option(`${i}. ${name}`, i));
});

surahSelect.addEventListener("change", updateAyahDropdown);
ayahSelect.addEventListener("change", loadAyat);
wordStart.addEventListener("change", () => {
  const start = +wordStart.value;
  wordEnd.innerHTML = '';
  for (let i = start; i <= words.length; i++) wordEnd.appendChild(new Option(i, i));
  wordEnd.value = start;
  loadAyat();
});
wordEnd.addEventListener("change", loadAyat);
wordTranslationId.addEventListener("change", loadAyat);
bgUpload.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => applyBackground(e.target.result);
  reader.readAsDataURL(file);
});
bgLink.addEventListener("change", () => applyBackground(bgLink.value));
bgSelect.addEventListener("change", () => applyBackground(`https://example.com/${bgSelect.value}.jpg`));
contrastControl.addEventListener("input", () => {
  const container = pages.querySelector(".page-container");
  if (container) container.style.filter = `contrast(${contrastControl.value}%)`;
});
colorPicker.addEventListener("change", () => {
  pages.querySelectorAll(".word, .translation").forEach(el => el.style.color = colorPicker.value);
});
fontSelect.addEventListener("change", () => {
  const url = fontSelect.value;
  if (!url) return;
  const fontName = `customFont${Date.now()}`;
  const style = document.createElement('style');
  style.textContent = `@font-face { font-family: '${fontName}'; src: url('${url}'); }
    .translation { font-family: '${fontName}', sans-serif !important; }`;
  document.head.appendChild(style);
});

document.getElementById("saveImageButton").addEventListener("click", async () => {
  const node = pages.querySelector(".page-container");
  const { toBlob } = await import('https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/+esm');
  toBlob(node).then(blob => {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "quran.png";
    a.click();
  });
});

function applyBackground(url) {
  const container = pages.querySelector(".page-container");
  if (container) container.style.backgroundImage = `url('${url}')`;
}

async function updateAyahDropdown() {
  const s = surahSelect.value;
  const res = await fetch(`https://api.quran.com/api/v4/chapters/${s}`);
  const json = await res.json();
  const max = json.chapter.verses_count;
  ayahSelect.innerHTML = "";
  for (let i = 1; i <= max; i++) ayahSelect.appendChild(new Option(`Ayat ${i}`, i));
  ayahSelect.value = 1;
  loadAyat();
}

async function loadAyat() {
  const s = surahSelect.value, a = ayahSelect.value, key = `${s}:${a}`;
  pages.innerHTML = "";
  const div = document.createElement("div");
  div.className = `page-container quran-${currentVersion}`;
  pages.appendChild(div);

  const data = await fetch(`https://api.quran.com/api/v4/verses/by_key/${key}?words=true&word_fields=code_${currentVersion}`).then(r => r.json());
  words = data.verse.words.map(w => ({ arabic: w[`code_${currentVersion}`] || w.text }));

  const startIdx = (+wordStart.value || 1) - 1;
  const endIdx = (+wordEnd.value || startIdx + 1);
  const line = document.createElement("div");
  for (let i = startIdx; i < endIdx; i++) {
    const span = document.createElement("span");
    span.className = "word";
    span.innerText = words[i].arabic;
    span.contentEditable = true;
    makeDraggable(span);
    line.appendChild(span);
    line.appendChild(document.createTextNode(" "));
  }
  div.appendChild(line);

  const lang = wordTranslationId.value === "33" ? "id" : "en";
  const j = await fetch(`https://api.quran.com/api/v4/verses/by_key/${key}?words=true&language=${lang}&translations=${wordTranslationId.value}`).then(r => r.json());
  const wordTranslations = j.verse.words.map(w => w.translation?.text || "").slice(startIdx, endIdx);
  const transDiv = document.createElement("div");
  transDiv.className = "translation";
  transDiv.contentEditable = true;
  transDiv.innerText = wordTranslations.join(" ");
  makeDraggable(transDiv);
  div.appendChild(transDiv);

  const source = document.createElement("div");
  source.className = "source-text";
  source.contentEditable = true;
  source.innerText = `${surahList[s][0]}: ${a}`;
  makeDraggable(source);
  div.appendChild(source);

  const watermark = document.createElement("div");
  watermark.className = "watermark";
  watermark.innerText = "videomurottal.com";
  div.appendChild(watermark);

  div.style.display = "block";
  div.style.opacity = "1";
}

function makeDraggable(el) {
  el.draggable = true;
  el.addEventListener('dragstart', e => {
    e.dataTransfer.setData("text/plain", null);
    e.target.dataset.dragging = true;
  });
  el.addEventListener('dragend', e => {
    e.target.dataset.dragging = false;
  });
  el.addEventListener('touchmove', e => {
    const touch = e.touches[0];
    el.style.left = touch.clientX - el.offsetWidth / 2 + 'px';
    el.style.top = touch.clientY - el.offsetHeight / 2 + 'px';
    el.style.position = 'absolute';
  });
}
  </script>
</body>
</html>
